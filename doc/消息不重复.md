# 消息不重复

1. 客户端在发送消息时，随机生成一个randomId，并将其发送给服务器。
2. 消息历史记录表中对这个randomId建立唯一索引,插入用`insert into ingore xxx`来保证消息不重复。
3. 插入成功,返回成功响应,缓存 _randomId_ to _chatHistoryId_ 到redis,并设置过期时间,
4. 插入失败,取出缓存中 _randomId_ 对应的 _chatHistoryId_ ,如果存在则返回成功响应,否则返回失败响应。
5. 客户端根据是否收到randomId对应的响应,来判断是否重发消息。

### step 1:

client send message to server

```json
{
  "randomId": "4444",
  "type": "chat",
  "toId": "1511197272837996544",
  "sessionType": "1",
  "chatMessage": {
    "content": "helasdlo",
    "contentType": 1
  }
}
```

### step 2:

server send response to client

```json
{
  "randomId": "4444",
  "type": "success",
  "message": "ok",
  "data": 307488766900178940
}
```

### step 3:

如果这时候客户端没收到响应,可以选择再次发送 `step 1`的数据.(前提是在服务端设置的缓存有效期之内)

服务端依然会返回

```json
{
  "randomId": "4444",
  "type": "success",
  "message": "ok",
  "data": 307488766900178940
}
```