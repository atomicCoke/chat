# Websocket

服务器地址固定为`114.132.249.192:8081`

连接地址为:

> 114.132.249.192:8081/echo

e.g: `ws://114.132.249.192:8081/echo?token=d5d59497-4ace-4837-82db-f154ba193008`

## 1.成功与失败响应

所有发送给后端的请求都要带上`randomId`，通过`randomId`来表示是否是同一对请求与响应。`randomId`由前端生成

## a.成功响应

```json
666666{
  "randomId": "12333333333333",
  "message": "成功消息",
  "data": 各种数据
}
```

## b.失败响应

```json
777777{
  "randomId": "12333333333333",
  "message": "失败消息"
}
```

## 2.发送消息

请求消息体: `ChatMessagePacket`

> 具体查看 **数据模型 > message > ChatMessagePacket**

```json
100101{
  "randomId": "12333333333333",
  "toId": "111111111111",
  "sessionType": "1",
  "sendTime": xxx
  "chatMessage": {
    "content": "你好",
    "contentType": 1
  }
}
```

### 成功时

1. 首先会返回第一个包：表示这条消息服务端正确收到

```
666666{
  "message": "ok",
  "randomId": "b70c6c13e10b0598",
}
```

2. 当消息成功入库后会返回

```jsonpath
100102{
  "data": {
    "boxOwnerId": "111111111111", #表示当前用户, 可与当前用户比较, 不同则丢弃
    "boxOwnerSeq": "2", #表示你发送的这条消息的seq
    "messageId": "308266463012257792"
  },
  "randomId": "094ca26e1f52ef8b", #你发送消息所携带的randomId
}
```

### 失败时

```jsonpath
777777{
  "message": "这条消息的缓存id已经过期,或randomId错误",
  "randomId": "b813f9f463f66c95"
}
```

## 3.关于seq

1. 后端保证每个人的seq都有各自的一份,各自递增
2. 每发一条消息或收到一条消息,则seq递增1
3. 如果服务端发送过来的seq小于客户端存储的seq则可以直接丢弃
4. 当客户端收到seq如果是不连续的话,需要从服务端拉取(localSeq,serverSeq]的消息记录

## 4.接收消息

```json
666666{
  "data": {
    "body": {
      "chatId": "310836395621314560",
      "chatMessage": {
        "content": "123",
        "contentType": 1
      },
      "fromAvatar": "http://114.132.249.192:9000/chat/1650954062000/309333536148815872blob",
      "fromId": "111111111111",
      "fromNickName": "fzdwx",
      "msgFrom": 1,
      "sendTime": "2022-04-30T17:52:51.7770797",
      "sessionType": 1,
      "toId": "444444444444"
    },
    "boxOwnerId": "444444444444",
    "boxOwnerSeq": "2",
    "messageType": "chat"
  },
  "message": "ok",
  "randomId": "12234"
}
```